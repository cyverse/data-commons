---
- name: Install and Configure CKAN on Ubuntu 22.04 with HTTPS and OIDC
  hosts: ckan_servers
  become: true
  vars_files:
    - group_vars/vault.yml
  
  vars:
    ckan_version: "2.11"
    solr_version: "9.5.0"
    ckan_domain: "dc.cyverse.org"
    ckan_site_url: "https://{{ ckan_domain }}"
    ckan_storage_path: "/var/lib/ckan/default/storage"
    ckan_port: 5000
    ckan_bind_host: "127.0.0.1"
    ckan_venv: "/usr/lib/ckan/default"
    ssl_certificate_path: "/etc/ssl/certs/cyverse.org.pem"
    ssl_certificate_key_path: "/etc/ssl/private/cyverse.org.key"

    java_home: "/usr/lib/jvm/java-11-openjdk-amd64"

    solr_port: 8983
    solr_install_dir: "/opt/solr"
    solr_data_dir: "/var/solr"

    redis_host: "127.0.0.1"
    redis_port: 6379

    # OIDC Configuration - Keycloak
    oidc_base_url: "https://kc.cyverse.org/auth"
    oidc_realm: "CyVerse"
    oidc_auth_path: "/realms/{{ oidc_realm }}/protocol/openid-connect/auth"
    oidc_token_path: "/realms/{{ oidc_realm }}/protocol/openid-connect/token"
    oidc_userinfo_path: "/realms/{{ oidc_realm }}/protocol/openid-connect/userinfo"
    oidc_redirect_path: "/local/oidc/handler"
    oidc_scope: "openid email profile"
    oidc_use_same_id: true
    oidc_munge_password: true
    
  tasks:
    - name: Assert required vault variables are defined
      ansible.builtin.assert:
        that:
          - ckan_db_user is defined
          - ckan_db_password is defined
          - ckan_db_name is defined
          - oidc_client_id is defined
          - oidc_client_secret is defined
        fail_msg: >
          One or more required vault variables are missing.
          Ensure ckan_db_user, ckan_db_password, ckan_db_name,
          oidc_client_id, and oidc_client_secret
          are all defined in group_vars/vault.yml.

    - name: Update system packages
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required dependencies
      ansible.builtin.apt:
        name:
          - libpq5
          - nginx
          - postgresql
          - postgresql-contrib
          - redis-server
          - supervisor
          - xz-utils
          - python3-pip
          - python3-venv
          - python3-dev
          - libpq-dev
          - git
          - openjdk-11-jdk
          - wget
          - curl
          - lsof
          - python3-psycopg2
        state: present

    - name: Verify SSL certificate exists
      ansible.builtin.stat:
        path: "{{ ssl_certificate_path }}"
      register: ssl_cert_file

    - name: Verify SSL private key exists
      ansible.builtin.stat:
        path: "{{ ssl_certificate_key_path }}"
      register: ssl_key_file

    - name: Assert SSL files are present
      ansible.builtin.assert:
        that:
          - ssl_cert_file.stat.exists
          - ssl_key_file.stat.exists
        fail_msg: >
          SSL certificate or key not found.
          Expected cert at {{ ssl_certificate_path }}
          and key at {{ ssl_certificate_key_path }}.

    - name: Display SSL certificate status
      ansible.builtin.debug:
        msg: "Using existing SSL certificates at {{ ssl_certificate_path }} and {{ ssl_certificate_key_path }}"

    - name: Create Java environment script
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          export JAVA_HOME="{{ java_home }}"
          export PATH="$JAVA_HOME/bin:$PATH"
        dest: /etc/profile.d/java.sh
        mode: '0755'
        owner: root
        group: root

    - name: Verify Java installation
      ansible.builtin.command: "{{ java_home }}/bin/java -version"
      register: java_version
      failed_when: java_version.rc != 0
      changed_when: false

    - name: Display Java version
      ansible.builtin.debug:
        msg: "Java version: {{ java_version.stderr_lines[0] }}"

    - name: Start and enable PostgreSQL
      ansible.builtin.systemd:
        name: postgresql
        state: started
        enabled: true

    - name: Start and enable Redis
      ansible.builtin.systemd:
        name: redis-server
        state: started
        enabled: true

    - name: Create CKAN database user
      become: yes
      become_user: postgres
      community.postgresql.postgresql_user:
        name: "{{ ckan_db_user }}"
        password: "{{ ckan_db_password }}"
        role_attr_flags: NOSUPERUSER,NOCREATEDB,NOCREATEROLE
        state: present

    - name: Create CKAN database
      become: yes
      become_user: postgres
      community.postgresql.postgresql_db:
        name: "{{ ckan_db_name }}"
        owner: "{{ ckan_db_user }}"
        encoding: "UTF-8"
        template: "template0"
        state: present

    - name: Download CKAN package
      ansible.builtin.get_url:
        url: "https://packaging.ckan.org/python-ckan_{{ ckan_version }}-{{ ansible_distribution_release }}_amd64.deb"
        dest: "/tmp/python-ckan_{{ ckan_version }}-{{ ansible_distribution_release }}_amd64.deb"
        mode: '0644'

    - name: Install CKAN package
      ansible.builtin.apt:
        deb: "/tmp/python-ckan_{{ ckan_version }}-{{ ansible_distribution_release }}_amd64.deb"
        state: present

    - name: Create CKAN directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'
        recurse: yes
      loop:
        - /var/lib/ckan
        - /var/lib/ckan/default
        - /var/lib/ckan/default/storage
        - /var/lib/ckan/default/webassets
        - /etc/ckan
        - /etc/ckan/default
        - /var/log/ckan

    - name: Check if Solr is already installed
      ansible.builtin.stat:
        path: "{{ solr_install_dir }}/bin/solr"
      register: solr_installed

    - name: Download and extract Solr
      ansible.builtin.unarchive:
        src: "https://archive.apache.org/dist/solr/solr/{{ solr_version }}/solr-{{ solr_version }}.tgz"
        dest: /opt
        remote_src: true
        owner: root
        group: root
      when: not solr_installed.stat.exists

    - name: Create Solr user
      ansible.builtin.user:
        name: solr
        system: yes
        shell: /bin/bash
        home: "{{ solr_data_dir }}"
        create_home: yes
        state: present

    - name: Create Solr directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: solr
        group: solr
        mode: '0755'
      loop:
        - "{{ solr_data_dir }}"
        - "{{ solr_data_dir }}/data"
        - "{{ solr_data_dir }}/logs"

    - name: Create Solr configuration file
      ansible.builtin.copy:
        dest: /etc/default/solr.in.sh
        content: |
          SOLR_PID_DIR="{{ solr_data_dir }}"
          SOLR_HOME="{{ solr_data_dir }}/data"
          LOG4J_PROPS="{{ solr_data_dir }}/log4j2.xml"
          SOLR_LOGS_DIR="{{ solr_data_dir }}/logs"
          SOLR_PORT="{{ solr_port }}"
        owner: solr
        group: solr
        mode: '0640'

    - name: Copy Solr installation files to {{ solr_install_dir }}
      ansible.builtin.shell: |
        mkdir -p {{ solr_install_dir }}
        cp -r /opt/solr-{{ solr_version }}/* {{ solr_install_dir }}/
        chown -R solr:solr {{ solr_install_dir }}
      args:
        creates: "{{ solr_install_dir }}/bin/solr"

    - name: Create Solr systemd service file
      ansible.builtin.copy:
        dest: /etc/systemd/system/solr.service
        content: |
          [Unit]
          Description=Apache Solr
          After=network.target

          [Service]
          Type=forking
          User=solr
          Group=solr
          WorkingDirectory={{ solr_install_dir }}
          EnvironmentFile=/etc/default/solr.in.sh
          ExecStart={{ solr_install_dir }}/bin/solr start -p {{ solr_port }}
          ExecStop={{ solr_install_dir }}/bin/solr stop
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: Reload systemd daemon

    - name: Flush handlers to reload systemd before starting Solr
      ansible.builtin.meta: flush_handlers

    - name: Start and enable Solr
      ansible.builtin.systemd:
        name: solr
        state: started
        enabled: true

    - name: Wait for Solr to be ready
      ansible.builtin.wait_for:
        port: "{{ solr_port }}"
        delay: 10
        timeout: 60

    - name: Check if CKAN core exists in Solr
      ansible.builtin.uri:
        url: "http://localhost:{{ solr_port }}/solr/admin/cores?action=STATUS&core=ckan"
        method: GET
        return_content: yes
      register: solr_core_check
      failed_when: false

    - name: Check if CKAN core directory exists in correct location
      ansible.builtin.stat:
        path: "{{ solr_data_dir }}/data/ckan/conf"
      register: ckan_core_dir

    - name: Delete CKAN core if it exists in wrong location
      become: true
      become_user: solr
      ansible.builtin.shell: "{{ solr_install_dir }}/bin/solr delete -c ckan"
      when:
        - solr_core_check.json is defined
        - solr_core_check.json.status is defined
        - solr_core_check.json.status.ckan is defined
        - not ckan_core_dir.stat.exists
      ignore_errors: yes

    - name: Wait briefly after core deletion
      ansible.builtin.pause:
        seconds: 3
      when:
        - solr_core_check.json is defined
        - solr_core_check.json.status is defined
        - solr_core_check.json.status.ckan is defined
        - not ckan_core_dir.stat.exists

    - name: Create Solr core for CKAN in correct location
      become: true
      become_user: solr
      ansible.builtin.shell: "{{ solr_install_dir }}/bin/solr create -c ckan"
      when: not ckan_core_dir.stat.exists

    - name: Verify CKAN core directory was created in correct location
      ansible.builtin.stat:
        path: "{{ solr_data_dir }}/data/ckan/conf"
      register: ckan_core_dir_verify

    - name: Assert CKAN Solr core was created successfully
      ansible.builtin.assert:
        that: ckan_core_dir_verify.stat.exists
        fail_msg: "CKAN Solr core directory was not created at {{ solr_data_dir }}/data/ckan/conf"

    - name: Download CKAN Solr schema
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/ckan/ckan/refs/heads/{{ ckan_version }}/ckan/config/solr/schema.xml"
        dest: /tmp/ckan_schema.xml
        mode: '0644'

    - name: Replace Solr schema with CKAN schema
      ansible.builtin.copy:
        src: /tmp/ckan_schema.xml
        dest: "{{ solr_data_dir }}/data/ckan/conf/managed-schema.xml"
        remote_src: true
        owner: solr
        group: solr
        mode: '0644'
      notify: Restart Solr

    - name: Flush handlers to restart Solr before proceeding
      ansible.builtin.meta: flush_handlers

    - name: Wait for Solr to be ready after restart
      ansible.builtin.wait_for:
        port: "{{ solr_port }}"
        delay: 10
        timeout: 60

    - name: Install ckanext-oidc-pkce in CKAN virtual environment
      ansible.builtin.pip:
        name: ckanext-oidc-pkce
        virtualenv: "{{ ckan_venv }}"
        state: present

    - name: Install redis Python package in CKAN virtual environment
      ansible.builtin.pip:
        name: redis
        virtualenv: "{{ ckan_venv }}"
        state: present

    - name: Generate session secret
      ansible.builtin.shell: >
        python3 -c 'import os, binascii; print(binascii.hexlify(os.urandom(32)).decode())'
      register: session_secret
      when: ckan_session_secret is not defined
      changed_when: false

    - name: Set session secret fact
      ansible.builtin.set_fact:
        ckan_session_secret: "{{ session_secret.stdout }}"
      when: ckan_session_secret is not defined

    - name: Create CKAN configuration file with OIDC settings
      ansible.builtin.copy:
        dest: /etc/ckan/default/ckan.ini
        content: |
          [app:main]
          use = egg:ckan

          ## Database Settings
          sqlalchemy.url = postgresql://{{ ckan_db_user }}:{{ ckan_db_password }}@localhost/{{ ckan_db_name }}

          ## Site Settings
          ckan.site_url = {{ ckan_site_url }}
          ckan.site_id = {{ ckan_site_id | default('default') }}

          ## Authentication Settings
          ckan.auth.user_create_organizations = False
          ckan.auth.create_user_via_web = False
          ckan.auth.public_user_details = False
          ckan.auth.create_dataset_if_not_in_organization = False
          ckan.auth.user_create_groups = False
          ckan.auth.user_delete_groups = False

          ## Solr Settings
          solr_url = http://127.0.0.1:{{ solr_port }}/solr/ckan

          ## Redis Settings
          ckan.redis.url = redis://{{ redis_host }}:{{ redis_port }}/0

          ## Plugins - OIDC PKCE enabled
          ckan.plugins = stats text_view image_view activity oidc_pkce

          ## Storage Settings
          ckan.storage_path = {{ ckan_storage_path }}

          ## Session Settings
          beaker.session.key = ckan
          beaker.session.secret = {{ ckan_session_secret }}

          ## OIDC PKCE Configuration
          ckanext.oidc_pkce.base_url = {{ oidc_base_url }}
          ckanext.oidc_pkce.client_id = {{ oidc_client_id }}
          ckanext.oidc_pkce.client_secret = {{ oidc_client_secret }}
          ckanext.oidc_pkce.auth_path = {{ oidc_auth_path }}
          ckanext.oidc_pkce.token_path = {{ oidc_token_path }}
          ckanext.oidc_pkce.userinfo_path = {{ oidc_userinfo_path }}
          ckanext.oidc_pkce.redirect_path = {{ oidc_redirect_path }}
          ckanext.oidc_pkce.scope = {{ oidc_scope }}
          ckanext.oidc_pkce.use_same_id = {{ oidc_use_same_id }}
          ckanext.oidc_pkce.munge_password = {{ oidc_munge_password }}

          ## Upload Settings
          ckan.uploads_enabled = true
          ckan.upload.group.types = jpg jpeg png gif
          ckan.upload.group.mimetypes = image/jpeg image/png image/gif

          ## Logging configuration
          [loggers]
          keys = root, ckan, ckanext

          [handlers]
          keys = console

          [formatters]
          keys = generic

          [logger_root]
          level = WARNING
          handlers = console

          [logger_ckan]
          level = INFO
          handlers = console
          qualname = ckan
          propagate = 0

          [logger_ckanext]
          level = DEBUG
          handlers = console
          qualname = ckanext
          propagate = 0

          [handler_console]
          class = StreamHandler
          args = (sys.stderr,)
          level = NOTSET
          formatter = generic

          [formatter_generic]
          format = %(asctime)s %(levelname)-5.5s [%(name)s] %(message)s
        owner: www-data
        group: www-data
        mode: '0640'
      notify: Restart CKAN

    - name: Check if CKAN database is already initialized
      ansible.builtin.shell: |
        cd {{ ckan_venv }}
        bin/ckan -c /etc/ckan/default/ckan.ini db status
      environment:
        CKAN_INI: /etc/ckan/default/ckan.ini
      register: ckan_db_status
      failed_when: false
      changed_when: false

    - name: Initialize CKAN database
      ansible.builtin.shell: |
        cd {{ ckan_venv }}
        bin/ckan -c /etc/ckan/default/ckan.ini db init
      environment:
        CKAN_INI: /etc/ckan/default/ckan.ini
      when: ckan_db_status.rc != 0 or 'database is not set up' in (ckan_db_status.stderr | lower)

    - name: Check if CKAN admin user already exists
      ansible.builtin.shell: |
        cd {{ ckan_venv }}
        bin/ckan -c /etc/ckan/default/ckan.ini user show {{ ckan_admin_user }}
      environment:
        CKAN_INI: /etc/ckan/default/ckan.ini
      register: user_exists
      failed_when: false
      changed_when: false
      when:
        - ckan_admin_user is defined
        - ckan_admin_email is defined
        - ckan_admin_password is defined

    - name: Create CKAN admin user
      ansible.builtin.shell: |
        cd {{ ckan_venv }}
        bin/ckan -c /etc/ckan/default/ckan.ini user add {{ ckan_admin_user }} \
          email={{ ckan_admin_email }} \
          password={{ ckan_admin_password }}
        bin/ckan -c /etc/ckan/default/ckan.ini sysadmin add {{ ckan_admin_user }}
      environment:
        CKAN_INI: /etc/ckan/default/ckan.ini
      when:
        - ckan_admin_user is defined
        - ckan_admin_email is defined
        - ckan_admin_password is defined
        - user_exists.rc != 0

    - name: Display admin user creation status
      ansible.builtin.debug:
        msg: >-
          {{
            'Admin user ' + ckan_admin_user + ' already exists - skipping creation'
            if (ckan_admin_user is defined and user_exists.rc == 0)
            else 'Admin credentials not defined in vault - skipping admin user creation'
          }}
      when: ckan_admin_user is not defined or user_exists.rc == 0

    - name: Create CKAN supervisor configuration
      ansible.builtin.copy:
        dest: /etc/supervisor/conf.d/ckan.conf
        content: |
          [program:ckan]
          command={{ ckan_venv }}/bin/ckan -c /etc/ckan/default/ckan.ini run --host 0.0.0.0 --port {{ ckan_port }}
          autostart=true
          autorestart=true
          redirect_stderr=true
          stdout_logfile=/var/log/ckan/ckan.log
          stderr_logfile=/var/log/ckan/ckan.error.log
          user=www-data
          environment=CKAN_INI="/etc/ckan/default/ckan.ini"
        mode: '0644'
      notify: Restart CKAN

    - name: Update supervisor
      ansible.builtin.shell: |
        supervisorctl reread
        supervisorctl update
      changed_when: false

    - name: Ensure CKAN is started via supervisor
      ansible.builtin.supervisorctl:
        name: ckan
        state: started

    - name: Wait for CKAN to be ready on port {{ ckan_port }}
      ansible.builtin.wait_for:
        port: "{{ ckan_port }}"
        delay: 5
        timeout: 60

    - name: Configure Nginx for CKAN with HTTPS
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/ckan
        content: |
          # HTTP - Redirect to HTTPS
          server {
              listen 80;
              server_name {{ ckan_domain }};
              return 301 https://$server_name$request_uri;
          }

          # HTTPS
          server {
              listen 443 ssl http2;
              server_name {{ ckan_domain }};
              client_max_body_size 100M;

              ssl_certificate {{ ssl_certificate_path }};
              ssl_certificate_key {{ ssl_certificate_key_path }};
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers HIGH:!aNULL:!MD5;
              ssl_prefer_server_ciphers on;
              ssl_session_cache shared:SSL:10m;
              ssl_session_timeout 10m;

              add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
              add_header X-Frame-Options SAMEORIGIN;
              add_header X-Content-Type-Options nosniff;
              add_header X-XSS-Protection "1; mode=block";

              location / {
                  proxy_pass http://{{ ckan_bind_host }}:{{ ckan_port }};
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_buffering off;
                  proxy_request_buffering off;
              }
          }
        mode: '0644'
      notify: Reload Nginx

    - name: Enable Nginx CKAN site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/ckan
        dest: /etc/nginx/sites-enabled/ckan
        state: link

    - name: Remove default Nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Test Nginx configuration
      ansible.builtin.command: nginx -t
      register: nginx_test
      changed_when: false
      failed_when: nginx_test.rc != 0

    - name: Start and enable Nginx
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: true

    - name: Flush handlers to reload Nginx before testing
      ansible.builtin.meta: flush_handlers

    - name: Wait for HTTPS to be ready
      ansible.builtin.wait_for:
        port: 443
        delay: 5
        timeout: 30

    - name: Test CKAN availability via HTTPS
      ansible.builtin.uri:
        url: "https://{{ ckan_domain }}"
        method: GET
        status_code: [200, 302]
        validate_certs: yes
      register: ckan_test
      retries: 5
      delay: 10
      until: ckan_test.status in [200, 302]

    - name: Verify CKAN is responding correctly
      ansible.builtin.fail:
        msg: "CKAN failed to start properly. Check logs at /var/log/ckan/ckan.log and /var/log/ckan/ckan.error.log"
      when: ckan_test.status not in [200, 302]

    - name: Display CKAN access information
      ansible.builtin.debug:
        msg:
          - "======================================"
          - "CKAN installation with OIDC completed!"
          - "======================================"
          - "Access CKAN at: https://{{ ckan_domain }}"
          - "OIDC Login: https://{{ ckan_domain }}/user/login/oidc-pkce"
          - "Admin user: {{ ckan_admin_user | default('Not created - define in vault') }}"
          - ""
          - "SSL Certificate: {{ ssl_certificate_path }}"
          - "SSL Private Key: {{ ssl_certificate_key_path }}"
          - ""
          - "OIDC Provider: {{ oidc_base_url }}"
          - "OIDC Realm: {{ oidc_realm }}"
          - "OIDC Client: {{ oidc_client_id }}"
          - ""
          - "Check status with:"
          - "  sudo supervisorctl status ckan"
          - "  sudo systemctl status solr"
          - "  sudo systemctl status nginx"
          - "  sudo tail -f /var/log/ckan/ckan.log"
          - "======================================"

  handlers:
    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: Restart Solr
      ansible.builtin.systemd:
        name: solr
        state: restarted

    - name: Restart CKAN
      ansible.builtin.supervisorctl:
        name: ckan
        state: restarted

    - name: Reload Nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded